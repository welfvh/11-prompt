/**
 * Component for editing and configuring prompts with user-friendly sections
 * Inspired by Intercom's prompt configuration approach
 */
import React, { useState, useEffect } from 'react';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from './ui/card';
import { Button } from './ui/button';
import { Input } from './ui/input';
import { Label } from './ui/label';
import { Textarea } from './ui/textarea';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from './ui/select';
import { Tabs, TabsContent, TabsList, TabsTrigger } from './ui/tabs';
import { ApiService } from '@/services/api';
import type { PromptConfig } from '@/types';
import { Save, Plus, Trash2 } from 'lucide-react';

interface PromptEditorProps {
  selectedPromptId: string;
  onPromptChange: (promptId: string) => void;
  onPromptUpdated: () => void;
}

export const PromptEditor: React.FC<PromptEditorProps> = ({
  selectedPromptId,
  onPromptChange,
  onPromptUpdated,
}) => {
  const [prompts, setPrompts] = useState<PromptConfig[]>([]);
  const [currentPrompt, setCurrentPrompt] = useState<PromptConfig | null>(null);
  const [isLoading, setIsLoading] = useState(false);
  const [isSaving, setIsSaving] = useState(false);

  // Load prompts list
  useEffect(() => {
    loadPrompts();
  }, []);

  // Load selected prompt
  useEffect(() => {
    if (selectedPromptId) {
      loadPrompt(selectedPromptId);
    }
  }, [selectedPromptId]);

  const loadPrompts = async () => {
    try {
      const data = await ApiService.listPrompts();
      setPrompts(data);
    } catch (error) {
      console.error('Error loading prompts:', error);
    }
  };

  const loadPrompt = async (id: string) => {
    setIsLoading(true);
    try {
      const data = await ApiService.getPrompt(id);
      setCurrentPrompt(data);
    } catch (error) {
      console.error('Error loading prompt:', error);
    } finally {
      setIsLoading(false);
    }
  };

  const handleSave = async () => {
    if (!currentPrompt) return;

    setIsSaving(true);
    try {
      if (prompts.find((p) => p.id === currentPrompt.id)) {
        await ApiService.updatePrompt(currentPrompt.id, currentPrompt);
      } else {
        await ApiService.createPrompt(currentPrompt);
      }

      await loadPrompts();
      onPromptUpdated();
    } catch (error) {
      console.error('Error saving prompt:', error);
      alert('Error saving prompt: ' + (error instanceof Error ? error.message : 'Unknown error'));
    } finally {
      setIsSaving(false);
    }
  };

  const handleCreateNew = () => {
    const newPrompt: PromptConfig = {
      id: `prompt_${Date.now()}`,
      name: 'New Prompt',
      tone: '',
      behavior: '',
      use_case: '',
      system_prompt: '',
      additional_instructions: '',
      metadata: {
        author: 'user',
        tags: [],
      },
    };
    setCurrentPrompt(newPrompt);
    onPromptChange(newPrompt.id);
  };

  const handleDelete = async () => {
    if (!currentPrompt || !confirm('Are you sure you want to delete this prompt?')) return;

    try {
      await ApiService.deletePrompt(currentPrompt.id);
      await loadPrompts();
      if (prompts.length > 0) {
        onPromptChange(prompts[0].id);
      }
      onPromptUpdated();
    } catch (error) {
      console.error('Error deleting prompt:', error);
      alert('Error deleting prompt: ' + (error instanceof Error ? error.message : 'Unknown error'));
    }
  };

  const updatePrompt = (updates: Partial<PromptConfig>) => {
    if (!currentPrompt) return;
    setCurrentPrompt({ ...currentPrompt, ...updates });
  };

  if (isLoading) {
    return (
      <Card>
        <CardContent className="p-6">
          <div className="text-center text-muted-foreground">Loading...</div>
        </CardContent>
      </Card>
    );
  }

  return (
    <Card className="h-full flex flex-col">
      <CardHeader>
        <div className="flex items-center justify-between">
          <div>
            <CardTitle>Prompt Configuration</CardTitle>
            <CardDescription>
              Configure tone, behavior, and system instructions
            </CardDescription>
          </div>
          <div className="flex gap-2">
            <Button onClick={handleCreateNew} size="sm" variant="outline">
              <Plus className="h-4 w-4 mr-1" />
              New
            </Button>
            {currentPrompt && currentPrompt.id !== 'default' && (
              <Button onClick={handleDelete} size="sm" variant="destructive">
                <Trash2 className="h-4 w-4" />
              </Button>
            )}
          </div>
        </div>
      </CardHeader>

      <CardContent className="flex-1 overflow-y-auto">
        {!currentPrompt ? (
          <div className="text-center text-muted-foreground py-8">
            Select or create a prompt to get started
          </div>
        ) : (
          <div className="space-y-6">
            {/* Prompt Selector */}
            <div className="space-y-2">
              <Label htmlFor="prompt-select">Select Prompt</Label>
              <Select
                value={currentPrompt.id}
                onValueChange={(value) => onPromptChange(value)}
              >
                <SelectTrigger id="prompt-select">
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  {prompts.map((prompt) => (
                    <SelectItem key={prompt.id} value={prompt.id}>
                      {prompt.name}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>

            {/* Basic Info */}
            <div className="space-y-2">
              <Label htmlFor="prompt-name">Prompt Name</Label>
              <Input
                id="prompt-name"
                value={currentPrompt.name}
                onChange={(e) => updatePrompt({ name: e.target.value })}
                placeholder="E.g., Customer Support - Friendly"
              />
            </div>

            <div className="space-y-2">
              <Label htmlFor="use-case">Use Case</Label>
              <Input
                id="use-case"
                value={currentPrompt.use_case}
                onChange={(e) => updatePrompt({ use_case: e.target.value })}
                placeholder="E.g., General customer support, Technical queries"
              />
            </div>

            {/* Configuration Tabs */}
            <Tabs defaultValue="tone" className="w-full">
              <TabsList className="grid w-full grid-cols-3">
                <TabsTrigger value="tone">Tone</TabsTrigger>
                <TabsTrigger value="behavior">Behavior</TabsTrigger>
                <TabsTrigger value="system">System Prompt</TabsTrigger>
              </TabsList>

              <TabsContent value="tone" className="space-y-4">
                <div className="space-y-2">
                  <Label htmlFor="tone">Tone</Label>
                  <Textarea
                    id="tone"
                    value={currentPrompt.tone}
                    onChange={(e) => updatePrompt({ tone: e.target.value })}
                    placeholder="E.g., professional, friendly, empathetic"
                    rows={4}
                  />
                  <p className="text-sm text-muted-foreground">
                    Define how the assistant should communicate. Consider: formality level,
                    emotional expression, personality traits.
                  </p>
                </div>

                <div className="bg-muted p-4 rounded-md space-y-2">
                  <h4 className="font-medium text-sm">Examples:</h4>
                  <ul className="text-sm text-muted-foreground space-y-1 list-disc list-inside">
                    <li>Professional and courteous</li>
                    <li>Warm and conversational</li>
                    <li>Direct and efficient</li>
                    <li>Patient and understanding</li>
                  </ul>
                </div>
              </TabsContent>

              <TabsContent value="behavior" className="space-y-4">
                <div className="space-y-2">
                  <Label htmlFor="behavior">Behavior Guidelines</Label>
                  <Textarea
                    id="behavior"
                    value={currentPrompt.behavior}
                    onChange={(e) => updatePrompt({ behavior: e.target.value })}
                    placeholder="E.g., Always verify customer identity, offer proactive solutions"
                    rows={6}
                  />
                  <p className="text-sm text-muted-foreground">
                    Define what the assistant should and shouldn't do. Include guidelines for
                    handling common scenarios.
                  </p>
                </div>

                <div className="bg-muted p-4 rounded-md space-y-2">
                  <h4 className="font-medium text-sm">Consider including:</h4>
                  <ul className="text-sm text-muted-foreground space-y-1 list-disc list-inside">
                    <li>Response structure (greet, address issue, close)</li>
                    <li>When to escalate to human agents</li>
                    <li>How to handle uncertainty</li>
                    <li>Privacy and security guidelines</li>
                  </ul>
                </div>
              </TabsContent>

              <TabsContent value="system" className="space-y-4">
                <div className="space-y-2">
                  <Label htmlFor="system-prompt">System Prompt</Label>
                  <Textarea
                    id="system-prompt"
                    value={currentPrompt.system_prompt}
                    onChange={(e) => updatePrompt({ system_prompt: e.target.value })}
                    placeholder="You are a customer service assistant..."
                    rows={12}
                    className="font-mono text-sm"
                  />
                  <p className="text-sm text-muted-foreground">
                    The complete system prompt sent to the AI model. This combines your tone,
                    behavior, and any specific instructions.
                  </p>
                </div>

                <div className="space-y-2">
                  <Label htmlFor="additional">Additional Instructions (Optional)</Label>
                  <Textarea
                    id="additional"
                    value={currentPrompt.additional_instructions || ''}
                    onChange={(e) => updatePrompt({ additional_instructions: e.target.value })}
                    placeholder="Any extra context or instructions..."
                    rows={4}
                  />
                </div>
              </TabsContent>
            </Tabs>

            {/* Save Button */}
            <div className="flex justify-end pt-4 border-t">
              <Button onClick={handleSave} disabled={isSaving}>
                <Save className="h-4 w-4 mr-2" />
                {isSaving ? 'Saving...' : 'Save Prompt'}
              </Button>
            </div>
          </div>
        )}
      </CardContent>
    </Card>
  );
};
